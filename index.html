<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON Tool</title>
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --bg-hover: #30363d;
            --border-color: #30363d;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --text-muted: #6e7681;
            --accent-blue: #58a6ff;
            --accent-green: #3fb950;
            --accent-orange: #d29922;
            --accent-red: #f85149;
            --accent-purple: #a371f7;
            --accent-cyan: #39c5cf;
            --string-color: #a5d6ff;
            --number-color: #79c0ff;
            --boolean-color: #ff7b72;
            --null-color: #ffa657;
            --key-color: #7ee787;
            --font-mono: 'SF Mono', 'Cascadia Code', 'Fira Code', 'JetBrains Mono', Consolas, monospace;
            --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
            --radius: 8px;
            --radius-sm: 4px;
            --shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            --transition: 0.2s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-sans);
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        /* Header */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 20px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            gap: 16px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            flex: 1;
            min-width: 0;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
        }

        .toolbar {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            font-size: 13px;
            font-weight: 500;
            font-family: var(--font-sans);
            color: var(--text-primary);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            cursor: pointer;
            transition: all var(--transition);
            white-space: nowrap;
        }

        .btn:hover {
            background: var(--bg-hover);
            border-color: var(--text-muted);
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: var(--bg-primary);
        }

        .btn-primary:hover {
            background: #79b8ff;
            border-color: #79b8ff;
        }

        .btn-success {
            background: var(--accent-green);
            border-color: var(--accent-green);
            color: var(--bg-primary);
        }

        .btn-success:hover {
            background: #56d364;
            border-color: #56d364;
        }

        .btn-icon {
            padding: 8px;
            min-width: 36px;
            justify-content: center;
        }

        .status {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 8px;
            font-size: 13px;
            color: var(--text-secondary);
            flex: 1;
            min-width: 0;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
        }

        .status-dot.valid {
            background: var(--accent-green);
            box-shadow: 0 0 8px var(--accent-green);
        }

        .status-dot.invalid {
            background: var(--accent-red);
            box-shadow: 0 0 8px var(--accent-red);
        }

        /* Main Container */
        .main-container {
            display: flex;
            height: calc(100vh - 57px);
        }

        /* Panels */
        .panel {
            display: flex;
            flex-direction: column;
            min-width: 300px;
            background: var(--bg-secondary);
        }

        .panel-left {
            flex: 1;
            border-right: 1px solid var(--border-color);
        }

        .panel-right {
            flex: 1;
        }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
        }

        .panel-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .panel-actions {
            display: flex;
            gap: 4px;
        }

        .panel-btn {
            padding: 4px 8px;
            font-size: 11px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: all var(--transition);
        }

        .panel-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .panel-content {
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        .panel-content.scrollable {
            overflow: auto;
        }

        /* Editor */
        .editor-wrapper {
            height: 100%;
            position: relative;
        }

        .editor {
            width: 100%;
            height: 100%;
            padding: 16px;
            font-family: var(--font-mono);
            font-size: 13px;
            line-height: 1.6;
            color: var(--text-primary);
            background: transparent;
            border: none;
            resize: none;
            outline: none;
            tab-size: 2;
            overflow: auto;
        }

        .editor::placeholder {
            color: var(--text-muted);
        }

        /* Tree View */
        .tree-container {
            padding: 16px;
        }

        .tree-node {
            font-family: var(--font-mono);
            font-size: 13px;
            line-height: 1.8;
        }

        .tree-item {
            display: flex;
            align-items: flex-start;
            padding: 2px 0;
            padding-left: 20px;
            position: relative;
            cursor: default;
        }

        .tree-item:hover {
            background: var(--bg-hover);
            border-radius: var(--radius-sm);
        }

        .tree-toggle {
            position: absolute;
            left: 2px;
            top: 4px;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-muted);
            font-size: 12px;
            font-family: var(--font-mono);
            border-radius: 2px;
            transition: all var(--transition);
        }

        .tree-toggle:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .tree-toggle.collapsed::before {
            content: '+';
            font-weight: 700;
        }

        .tree-toggle.expanded::before {
            content: '‚àí';
            font-weight: 700;
        }

        .tree-key {
            color: var(--key-color);
            margin-right: 4px;
        }

        .tree-key::after {
            content: ':';
            color: var(--text-muted);
            margin-right: 8px;
        }

        .tree-value {
            flex: 1;
        }

        .tree-value.string {
            color: var(--string-color);
        }

        .tree-value.string::before,
        .tree-value.string::after {
            content: '"';
            color: var(--string-color);
            opacity: 0.6;
        }

        .tree-value.number {
            color: var(--number-color);
        }

        .tree-value.boolean {
            color: var(--boolean-color);
        }

        .tree-value.null {
            color: var(--null-color);
            font-style: italic;
        }

        .tree-bracket {
            color: var(--text-muted);
        }

        .tree-children {
            margin-left: 16px;
            border-left: 1px solid var(--border-color);
        }

        .tree-children.collapsed {
            display: none;
        }

        .tree-summary {
            color: var(--text-muted);
            font-size: 12px;
            margin-left: 4px;
        }

        .tree-index {
            color: var(--text-muted);
            margin-right: 4px;
            font-size: 11px;
        }

        /* Editable values */
        .tree-value[contenteditable="true"] {
            outline: none;
            padding: 0 4px;
            margin: 0 -4px;
            border-radius: 2px;
            min-width: 20px;
        }

        .tree-value[contenteditable="true"]:focus {
            background: var(--bg-primary);
            box-shadow: 0 0 0 2px var(--accent-blue);
        }

        /* Resizer */
        .resizer {
            width: 4px;
            background: var(--border-color);
            cursor: col-resize;
            transition: background var(--transition);
            flex-shrink: 0;
        }

        .resizer:hover,
        .resizer.active {
            background: var(--accent-blue);
        }

        /* Search Bar */
        .search-container {
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
        }

        .search-input {
            width: 100%;
            padding: 8px 12px;
            font-size: 13px;
            font-family: var(--font-sans);
            color: var(--text-primary);
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            outline: none;
            transition: all var(--transition);
        }

        .search-input:focus {
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.15);
        }

        .search-input::placeholder {
            color: var(--text-muted);
        }

        /* Clipboard Banner */
        .clipboard-banner {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 12px 20px;
            background: linear-gradient(135deg, rgba(88, 166, 255, 0.1), rgba(163, 113, 247, 0.1));
            border-bottom: 1px solid var(--border-color);
            animation: slideDown 0.3s ease;
        }

        .clipboard-banner.show {
            display: flex;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .clipboard-banner-text {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .clipboard-banner-preview {
            font-family: var(--font-mono);
            font-size: 12px;
            color: var(--text-muted);
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .toast {
            padding: 12px 20px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            font-size: 13px;
            color: var(--text-primary);
            animation: toastIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toast.success {
            border-left: 3px solid var(--accent-green);
        }

        .toast.error {
            border-left: 3px solid var(--accent-red);
        }

        .toast.info {
            border-left: 3px solid var(--accent-blue);
        }

        @keyframes toastIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Error Display */
        .error-display {
            padding: 16px;
            color: var(--accent-red);
            font-family: var(--font-mono);
            font-size: 13px;
            white-space: pre-wrap;
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 40px;
            text-align: center;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 14px;
            max-width: 280px;
            line-height: 1.6;
        }

        /* Path Display */
        .path-display {
            padding: 8px 16px;
            background: var(--bg-primary);
            border-top: 1px solid var(--border-color);
            font-family: var(--font-mono);
            font-size: 12px;
            color: var(--text-secondary);
            min-height: 36px;
            display: flex;
            align-items: center;
        }

        .path-display-label {
            color: var(--text-muted);
            margin-right: 8px;
        }

        .path-display-value {
            color: var(--accent-cyan);
        }

        /* Stats Bar */
        .stats-bar {
            display: flex;
            gap: 16px;
            padding: 8px 16px;
            background: var(--bg-primary);
            border-top: 1px solid var(--border-color);
            font-size: 12px;
            color: var(--text-muted);
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .stat-value {
            color: var(--text-secondary);
            font-family: var(--font-mono);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.2s ease;
        }

        .modal-overlay.show {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            max-width: 500px;
            width: 90%;
            animation: modalIn 0.3s ease;
        }

        @keyframes modalIn {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(-10px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: 16px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 18px;
            padding: 4px;
            line-height: 1;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        /* Type Badge */
        .type-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .type-badge.object {
            background: rgba(163, 113, 247, 0.2);
            color: var(--accent-purple);
        }

        .type-badge.array {
            background: rgba(57, 197, 207, 0.2);
            color: var(--accent-cyan);
        }

        /* Keyboard Shortcuts */
        kbd {
            display: inline-block;
            padding: 2px 6px;
            font-size: 11px;
            font-family: var(--font-mono);
            color: var(--text-secondary);
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--bg-hover);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* Highlight */
        .highlight {
            background: rgba(210, 153, 34, 0.3);
            border-radius: 2px;
        }

        /* Context Menu */
        .context-menu {
            position: fixed;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            min-width: 180px;
            z-index: 1000;
            padding: 4px 0;
            display: none;
        }

        .context-menu.show {
            display: block;
        }

        .context-menu-item {
            padding: 8px 12px;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-primary);
        }

        .context-menu-item:hover {
            background: var(--bg-hover);
        }

        .context-menu-separator {
            height: 1px;
            background: var(--border-color);
            margin: 4px 0;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                padding: 12px;
            }

            .toolbar {
                justify-content: center;
            }

            .main-container {
                flex-direction: column;
                height: calc(100vh - 120px);
            }

            .panel {
                min-width: 0;
                min-height: 200px;
            }

            .panel-left {
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }

            .resizer {
                width: 100%;
                height: 4px;
                cursor: row-resize;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">
            <div class="logo-icon">{}</div>
            <span>JSON Tool</span>
        </div>
        
        <div class="toolbar">
            <button class="btn btn-primary" id="pasteBtn" title="Paste from clipboard (Ctrl+V)">
                üìã Paste
            </button>
            <button class="btn" id="formatBtn" title="Format JSON (Ctrl+Shift+F)">
                ‚ú® Format
            </button>
            <button class="btn" id="minifyBtn" title="Minify JSON">
                üì¶ Minify
            </button>
            <button class="btn" id="copyBtn" title="Copy to clipboard (Ctrl+C)">
                üìÑ Copy
            </button>
            <button class="btn" id="downloadBtn" title="Download as file">
                üíæ Download
            </button>
            <button class="btn" id="clearBtn" title="Clear all">
                üóëÔ∏è Clear
            </button>
            <button class="btn" id="sampleBtn" title="Load sample JSON">
                üìù Sample
            </button>
        </div>

        <div class="status">
            <span class="status-dot" id="statusDot"></span>
            <span id="statusText">Ready</span>
        </div>
    </header>

    <div class="clipboard-banner" id="clipboardBanner">
        <span class="clipboard-banner-text">JSON detected in clipboard:</span>
        <span class="clipboard-banner-preview" id="clipboardPreview"></span>
        <button class="btn btn-success" id="pasteClipboardBtn">Paste JSON</button>
        <button class="btn" id="dismissClipboardBtn">Dismiss</button>
    </div>

    <main class="main-container">
        <section class="panel panel-left">
            <div class="panel-header">
                <span class="panel-title">Raw JSON</span>
                <div class="panel-actions">
                    <button class="panel-btn" id="wrapBtn">Wrap</button>
                    <button class="panel-btn" id="undoBtn">Undo</button>
                    <button class="panel-btn" id="redoBtn">Redo</button>
                </div>
            </div>
            <div class="panel-content">
                <div class="editor-wrapper">
                    <textarea 
                        class="editor" 
                        id="jsonEditor" 
                        placeholder="Paste or type your JSON here...&#10;&#10;Tips:&#10;‚Ä¢ Press Ctrl+V to paste&#10;‚Ä¢ Press Ctrl+Shift+F to format&#10;‚Ä¢ The tool auto-fixes common JSON issues"
                        spellcheck="false"
                    ></textarea>
                </div>
            </div>
            <div class="stats-bar">
                <div class="stat-item">
                    <span>Size:</span>
                    <span class="stat-value" id="sizeValue">0 B</span>
                </div>
                <div class="stat-item">
                    <span>Lines:</span>
                    <span class="stat-value" id="linesValue">0</span>
                </div>
                <div class="stat-item">
                    <span>Depth:</span>
                    <span class="stat-value" id="depthValue">0</span>
                </div>
            </div>
        </section>

        <div class="resizer" id="resizer"></div>

        <section class="panel panel-right">
            <div class="panel-header">
                <span class="panel-title">Tree View</span>
                <div class="panel-actions">
                    <button class="panel-btn" id="expandAllBtn">Expand All</button>
                    <button class="panel-btn" id="collapseAllBtn">Collapse All</button>
                </div>
            </div>
            <div class="search-container">
                <input 
                    type="text" 
                    class="search-input" 
                    id="searchInput" 
                    placeholder="Search keys or values... (Ctrl+F)"
                >
            </div>
            <div class="panel-content scrollable">
                <div class="tree-container" id="treeContainer">
                    <div class="empty-state" id="emptyState">
                        <div class="empty-state-icon">{ }</div>
                        <div class="empty-state-text">
                            Paste or type JSON in the left panel to see the interactive tree view here
                        </div>
                    </div>
                </div>
            </div>
            <div class="path-display">
                <span class="path-display-label">Path:</span>
                <span class="path-display-value" id="pathValue">$</span>
            </div>
        </section>
    </main>

    <div class="toast-container" id="toastContainer"></div>

    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" data-action="copy-value">üìã Copy Value</div>
        <div class="context-menu-item" data-action="copy-path">üîó Copy Path</div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" data-action="add-property">‚ûï Add Property</div>
        <div class="context-menu-item" data-action="delete">üóëÔ∏è Delete</div>
    </div>

    <script>
        // ============================================
        // JSON Tool - Core Application
        // ============================================

        class JSONTool {
            constructor() {
                this.jsonData = null;
                this.history = [];
                this.historyIndex = -1;
                this.maxHistory = 50;
                this.isUpdating = false;
                this.clipboardJSON = null;
                this.currentPath = '$';
                this.contextMenuTarget = null;
                this.clipboardChecked = false;
                this.clipboardPermissionDenied = false;

                this.initElements();
                this.initEventListeners();
                // Only check clipboard once on initial load, with a slight delay
                setTimeout(() => this.checkClipboard(), 500);
            }

            // Initialize DOM elements
            initElements() {
                this.editor = document.getElementById('jsonEditor');
                this.treeContainer = document.getElementById('treeContainer');
                this.emptyState = document.getElementById('emptyState');
                this.statusDot = document.getElementById('statusDot');
                this.statusText = document.getElementById('statusText');
                this.clipboardBanner = document.getElementById('clipboardBanner');
                this.clipboardPreview = document.getElementById('clipboardPreview');
                this.searchInput = document.getElementById('searchInput');
                this.pathValue = document.getElementById('pathValue');
                this.toastContainer = document.getElementById('toastContainer');
                this.contextMenu = document.getElementById('contextMenu');
                this.resizer = document.getElementById('resizer');

                // Stats
                this.sizeValue = document.getElementById('sizeValue');
                this.linesValue = document.getElementById('linesValue');
                this.depthValue = document.getElementById('depthValue');
            }

            // Initialize event listeners
            initEventListeners() {
                // Editor events
                this.editor.addEventListener('input', () => this.handleEditorInput());
                this.editor.addEventListener('paste', (e) => this.handlePaste(e));

                // Toolbar buttons
                document.getElementById('pasteBtn').addEventListener('click', () => this.pasteFromClipboard());
                document.getElementById('formatBtn').addEventListener('click', () => this.formatJSON());
                document.getElementById('minifyBtn').addEventListener('click', () => this.minifyJSON());
                document.getElementById('copyBtn').addEventListener('click', () => this.copyToClipboard());
                document.getElementById('downloadBtn').addEventListener('click', () => this.downloadJSON());
                document.getElementById('clearBtn').addEventListener('click', () => this.clearAll());
                document.getElementById('sampleBtn').addEventListener('click', () => this.loadSample());

                // Panel buttons
                document.getElementById('expandAllBtn').addEventListener('click', () => this.expandAll());
                document.getElementById('collapseAllBtn').addEventListener('click', () => this.collapseAll());
                document.getElementById('wrapBtn').addEventListener('click', () => this.toggleWrap());
                document.getElementById('undoBtn').addEventListener('click', () => this.undo());
                document.getElementById('redoBtn').addEventListener('click', () => this.redo());

                // Clipboard banner
                document.getElementById('pasteClipboardBtn').addEventListener('click', () => this.pasteDetectedJSON());
                document.getElementById('dismissClipboardBtn').addEventListener('click', () => this.dismissClipboardBanner());

                // Search
                this.searchInput.addEventListener('input', () => this.handleSearch());

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => this.handleKeydown(e));

                // Resizer
                this.initResizer();

                // Context menu
                document.addEventListener('click', () => this.hideContextMenu());
                this.contextMenu.addEventListener('click', (e) => this.handleContextMenuClick(e));
            }

            // ============================================
            // JSON Parsing & Validation
            // ============================================

            parseJSON(text) {
                if (!text || !text.trim()) {
                    return { success: false, error: 'Empty input' };
                }

                // Try to fix common issues
                let fixedText = this.tryFixJSON(text);

                try {
                    const data = JSON.parse(fixedText);
                    return { success: true, data, fixed: fixedText !== text };
                } catch (e) {
                    return { success: false, error: e.message };
                }
            }

            tryFixJSON(text) {
                let fixed = text.trim();

                // Remove BOM
                fixed = fixed.replace(/^\uFEFF/, '');

                // Try to find JSON object or array
                const objectMatch = fixed.match(/\{[\s\S]*\}/);
                const arrayMatch = fixed.match(/\[[\s\S]*\]/);

                if (objectMatch && (!arrayMatch || objectMatch.index <= arrayMatch.index)) {
                    fixed = objectMatch[0];
                } else if (arrayMatch) {
                    fixed = arrayMatch[0];
                }

                // Fix trailing commas
                fixed = fixed.replace(/,(\s*[}\]])/g, '$1');

                // Fix single quotes to double quotes (careful with content)
                // This is a simple fix that might not work for all cases
                fixed = fixed.replace(/(['"])?([a-zA-Z0-9_]+)(['"])?\s*:/g, '"$2":');

                return fixed;
            }

            // ============================================
            // Editor Handling
            // ============================================

            handleEditorInput() {
                if (this.isUpdating) return;

                const text = this.editor.value;
                this.updateStats(text);

                const result = this.parseJSON(text);

                if (result.success) {
                    this.jsonData = result.data;
                    this.setStatus('valid', 'Valid JSON' + (result.fixed ? ' (auto-fixed)' : ''));
                    this.renderTree();
                    this.saveToHistory(text);
                } else if (text.trim()) {
                    this.jsonData = null;
                    this.setStatus('invalid', 'Invalid JSON');
                    this.showTreeError(result.error);
                } else {
                    this.jsonData = null;
                    this.setStatus('', 'Ready');
                    this.showEmptyState();
                }
            }

            handlePaste(e) {
                // Let the default paste happen, then process
                setTimeout(() => this.handleEditorInput(), 0);
            }

            updateStats(text) {
                const size = new Blob([text]).size;
                this.sizeValue.textContent = this.formatBytes(size);
                this.linesValue.textContent = text ? text.split('\n').length : 0;
                
                if (this.jsonData) {
                    this.depthValue.textContent = this.getDepth(this.jsonData);
                } else {
                    this.depthValue.textContent = 0;
                }
            }

            formatBytes(bytes) {
                if (bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
            }

            getDepth(obj, current = 0) {
                if (typeof obj !== 'object' || obj === null) return current;
                const children = Object.values(obj);
                if (children.length === 0) return current;
                return Math.max(...children.map(child => this.getDepth(child, current + 1)));
            }

            // ============================================
            // Tree View Rendering
            // ============================================

            renderTree() {
                if (!this.jsonData) {
                    this.showEmptyState();
                    return;
                }

                this.emptyState.style.display = 'none';
                const tree = this.createTreeNode(this.jsonData, '$', null, true);
                this.treeContainer.innerHTML = '';
                this.treeContainer.appendChild(tree);
            }

            createTreeNode(data, path, key = null, isRoot = false) {
                const container = document.createElement('div');
                container.className = 'tree-node';
                container.dataset.path = path;

                const type = this.getType(data);
                const isExpandable = type === 'object' || type === 'array';

                const item = document.createElement('div');
                item.className = 'tree-item';

                // Toggle button for expandable items
                if (isExpandable) {
                    const toggle = document.createElement('span');
                    toggle.className = 'tree-toggle expanded';
                    item.appendChild(toggle);
                    
                    // Make entire row clickable for expand/collapse
                    item.style.cursor = 'pointer';
                    item.addEventListener('click', (e) => {
                        // Don't toggle if clicking on editable content
                        if (e.target.contentEditable === 'true') return;
                        this.toggleNode(toggle);
                        this.pathValue.textContent = path;
                        this.currentPath = path;
                    });
                }

                // Key (for object properties)
                if (key !== null && !Array.isArray(this.getParentData(path))) {
                    const keySpan = document.createElement('span');
                    keySpan.className = 'tree-key';
                    keySpan.textContent = key;
                    keySpan.contentEditable = true;
                    keySpan.dataset.originalKey = key;
                    keySpan.addEventListener('blur', (e) => this.handleKeyEdit(e, path));
                    keySpan.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            e.target.blur();
                        }
                    });
                    item.appendChild(keySpan);
                } else if (key !== null) {
                    const indexSpan = document.createElement('span');
                    indexSpan.className = 'tree-index';
                    indexSpan.textContent = `[${key}]`;
                    item.appendChild(indexSpan);
                }

                // Value
                const valueSpan = document.createElement('span');
                valueSpan.className = 'tree-value ' + type;

                if (isExpandable) {
                    const bracket = document.createElement('span');
                    bracket.className = 'tree-bracket';
                    bracket.textContent = type === 'array' ? '[' : '{';
                    valueSpan.appendChild(bracket);

                    const summary = document.createElement('span');
                    summary.className = 'tree-summary';
                    const count = type === 'array' ? data.length : Object.keys(data).length;
                    summary.textContent = `${count} ${count === 1 ? 'item' : 'items'}`;
                    valueSpan.appendChild(summary);

                    const badge = document.createElement('span');
                    badge.className = 'type-badge ' + type;
                    badge.textContent = type;
                    valueSpan.appendChild(badge);
                } else {
                    valueSpan.textContent = this.formatValue(data, type);
                    valueSpan.contentEditable = true;
                    valueSpan.dataset.type = type;
                    valueSpan.addEventListener('blur', (e) => this.handleValueEdit(e, path));
                    valueSpan.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            e.target.blur();
                        }
                    });
                    valueSpan.addEventListener('focus', () => {
                        this.pathValue.textContent = path;
                        this.currentPath = path;
                    });
                }

                item.appendChild(valueSpan);

                // Context menu
                item.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    this.showContextMenu(e, path, data);
                });

                // Update path display on click (for non-expandable items)
                if (!isExpandable) {
                    item.addEventListener('click', () => {
                        this.pathValue.textContent = path;
                        this.currentPath = path;
                    });
                }

                container.appendChild(item);

                // Children for expandable items
                if (isExpandable) {
                    const children = document.createElement('div');
                    children.className = 'tree-children';

                    if (type === 'array') {
                        data.forEach((child, index) => {
                            const childPath = `${path}[${index}]`;
                            children.appendChild(this.createTreeNode(child, childPath, index));
                        });
                    } else {
                        Object.entries(data).forEach(([childKey, child]) => {
                            const childPath = `${path}.${childKey}`;
                            children.appendChild(this.createTreeNode(child, childPath, childKey));
                        });
                    }

                    // Closing bracket
                    const closingItem = document.createElement('div');
                    closingItem.className = 'tree-item';
                    closingItem.style.paddingLeft = '4px';
                    const closingBracket = document.createElement('span');
                    closingBracket.className = 'tree-bracket';
                    closingBracket.textContent = type === 'array' ? ']' : '}';
                    closingItem.appendChild(closingBracket);
                    children.appendChild(closingItem);

                    container.appendChild(children);
                }

                return container;
            }

            getType(value) {
                if (value === null) return 'null';
                if (Array.isArray(value)) return 'array';
                return typeof value;
            }

            formatValue(value, type) {
                if (type === 'string') return value;
                if (type === 'null') return 'null';
                return String(value);
            }

            getParentData(path) {
                const parts = this.parsePath(path);
                parts.pop();
                return this.getValueAtPath(parts);
            }

            parsePath(path) {
                const parts = [];
                const regex = /\.([^.\[\]]+)|\[(\d+)\]/g;
                let match;
                while ((match = regex.exec(path)) !== null) {
                    if (match[1] !== undefined) parts.push(match[1]);
                    if (match[2] !== undefined) parts.push(parseInt(match[2]));
                }
                return parts;
            }

            getValueAtPath(parts) {
                let current = this.jsonData;
                for (const part of parts) {
                    if (current === null || current === undefined) return undefined;
                    current = current[part];
                }
                return current;
            }

            setValueAtPath(parts, value) {
                if (parts.length === 0) {
                    this.jsonData = value;
                    return;
                }

                let current = this.jsonData;
                for (let i = 0; i < parts.length - 1; i++) {
                    current = current[parts[i]];
                }
                current[parts[parts.length - 1]] = value;
            }

            toggleNode(toggle) {
                const isExpanded = toggle.classList.contains('expanded');
                const children = toggle.closest('.tree-node').querySelector('.tree-children');
                
                if (isExpanded) {
                    toggle.classList.remove('expanded');
                    toggle.classList.add('collapsed');
                    children.classList.add('collapsed');
                } else {
                    toggle.classList.remove('collapsed');
                    toggle.classList.add('expanded');
                    children.classList.remove('collapsed');
                }
            }

            // ============================================
            // Tree Editing
            // ============================================

            handleValueEdit(e, path) {
                const span = e.target;
                let newValue = span.textContent.trim();
                const type = span.dataset.type;

                // Parse the new value based on expected type
                let parsedValue;
                if (newValue === 'null') {
                    parsedValue = null;
                } else if (newValue === 'true') {
                    parsedValue = true;
                } else if (newValue === 'false') {
                    parsedValue = false;
                } else if (!isNaN(newValue) && newValue !== '') {
                    parsedValue = parseFloat(newValue);
                } else {
                    parsedValue = newValue;
                }

                const parts = this.parsePath(path);
                this.setValueAtPath(parts, parsedValue);
                this.syncEditorFromTree();
            }

            handleKeyEdit(e, path) {
                const span = e.target;
                const newKey = span.textContent.trim();
                const oldKey = span.dataset.originalKey;

                if (newKey === oldKey || !newKey) {
                    span.textContent = oldKey;
                    return;
                }

                const parts = this.parsePath(path);
                const parentParts = parts.slice(0, -1);
                const parent = parentParts.length ? this.getValueAtPath(parentParts) : this.jsonData;
                
                if (parent && typeof parent === 'object' && !Array.isArray(parent)) {
                    const value = parent[oldKey];
                    delete parent[oldKey];
                    parent[newKey] = value;
                    span.dataset.originalKey = newKey;
                    this.syncEditorFromTree();
                }
            }

            syncEditorFromTree() {
                this.isUpdating = true;
                this.editor.value = JSON.stringify(this.jsonData, null, 2);
                this.updateStats(this.editor.value);
                this.saveToHistory(this.editor.value);
                this.isUpdating = false;
            }

            // ============================================
            // UI State
            // ============================================

            setStatus(state, message) {
                this.statusDot.className = 'status-dot ' + state;
                this.statusText.textContent = message;
            }

            showEmptyState() {
                this.emptyState.style.display = 'flex';
                const tree = this.treeContainer.querySelector('.tree-node');
                if (tree) tree.remove();
            }

            showTreeError(error) {
                this.emptyState.style.display = 'none';
                const existingTree = this.treeContainer.querySelector('.tree-node');
                if (existingTree) existingTree.remove();

                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-display';
                errorDiv.textContent = '‚ùå Parse Error:\n' + error;
                
                const existingError = this.treeContainer.querySelector('.error-display');
                if (existingError) existingError.remove();
                
                this.treeContainer.appendChild(errorDiv);
            }

            // ============================================
            // Clipboard Handling
            // ============================================

            async checkClipboard() {
                // Only check once, and don't retry if permission was denied
                if (this.clipboardChecked || this.clipboardPermissionDenied) return;
                this.clipboardChecked = true;

                try {
                    // Check if clipboard-read permission is available
                    if (navigator.permissions) {
                        const permissionStatus = await navigator.permissions.query({ name: 'clipboard-read' });
                        if (permissionStatus.state === 'denied') {
                            this.clipboardPermissionDenied = true;
                            return;
                        }
                        // Only proceed if already granted, don't prompt
                        if (permissionStatus.state !== 'granted') {
                            return;
                        }
                    }

                    const text = await navigator.clipboard.readText();
                    const result = this.parseJSON(text);
                    
                    if (result.success) {
                        this.clipboardJSON = text;
                        this.clipboardPreview.textContent = text.substring(0, 50) + (text.length > 50 ? '...' : '');
                        this.clipboardBanner.classList.add('show');
                    }
                } catch (e) {
                    // Clipboard access denied or empty - don't show banner, don't retry
                    this.clipboardPermissionDenied = true;
                }
            }

            async pasteFromClipboard() {
                try {
                    const text = await navigator.clipboard.readText();
                    this.editor.value = text;
                    this.handleEditorInput();
                    this.clipboardBanner.classList.remove('show');
                    this.showToast('Pasted from clipboard', 'success');
                } catch (e) {
                    this.showToast('Could not access clipboard', 'error');
                }
            }

            pasteDetectedJSON() {
                if (this.clipboardJSON) {
                    this.editor.value = this.clipboardJSON;
                    this.handleEditorInput();
                    this.clipboardBanner.classList.remove('show');
                    this.showToast('JSON pasted successfully', 'success');
                }
            }

            dismissClipboardBanner() {
                this.clipboardBanner.classList.remove('show');
            }

            async copyToClipboard() {
                const text = this.editor.value;
                if (!text) {
                    this.showToast('Nothing to copy', 'info');
                    return;
                }

                try {
                    await navigator.clipboard.writeText(text);
                    this.showToast('Copied to clipboard', 'success');
                } catch (e) {
                    this.showToast('Could not copy to clipboard', 'error');
                }
            }

            // ============================================
            // JSON Operations
            // ============================================

            formatJSON() {
                if (!this.jsonData) {
                    this.showToast('No valid JSON to format', 'error');
                    return;
                }

                this.isUpdating = true;
                this.editor.value = JSON.stringify(this.jsonData, null, 2);
                this.updateStats(this.editor.value);
                this.saveToHistory(this.editor.value);
                this.isUpdating = false;
                this.showToast('JSON formatted', 'success');
            }

            minifyJSON() {
                if (!this.jsonData) {
                    this.showToast('No valid JSON to minify', 'error');
                    return;
                }

                this.isUpdating = true;
                this.editor.value = JSON.stringify(this.jsonData);
                this.updateStats(this.editor.value);
                this.saveToHistory(this.editor.value);
                this.isUpdating = false;
                this.showToast('JSON minified', 'success');
            }

            downloadJSON() {
                const text = this.editor.value;
                if (!text) {
                    this.showToast('Nothing to download', 'info');
                    return;
                }

                const blob = new Blob([text], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'data.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                this.showToast('Downloaded as data.json', 'success');
            }

            clearAll() {
                this.editor.value = '';
                this.jsonData = null;
                this.setStatus('', 'Ready');
                this.showEmptyState();
                this.updateStats('');
                this.pathValue.textContent = '$';
                this.searchInput.value = '';
                
                const errorDisplay = this.treeContainer.querySelector('.error-display');
                if (errorDisplay) errorDisplay.remove();
                
                this.showToast('Cleared', 'info');
            }

            loadSample() {
                const sample = {
                    "name": "JSON Tool",
                    "version": "1.0.0",
                    "description": "A powerful JSON viewer and editor",
                    "features": [
                        "Format & minify",
                        "Tree view",
                        "Live editing",
                        "Search & filter",
                        "Copy & download"
                    ],
                    "settings": {
                        "theme": "dark",
                        "autoFormat": true,
                        "expandDepth": 3
                    },
                    "stats": {
                        "users": 1000,
                        "rating": 4.8,
                        "isActive": true,
                        "lastUpdate": null
                    },
                    "nested": {
                        "level1": {
                            "level2": {
                                "level3": {
                                    "value": "Deep nesting example"
                                }
                            }
                        }
                    }
                };

                this.editor.value = JSON.stringify(sample, null, 2);
                this.handleEditorInput();
                this.showToast('Sample JSON loaded', 'success');
            }

            // ============================================
            // Search
            // ============================================

            handleSearch() {
                const query = this.searchInput.value.toLowerCase().trim();
                const items = this.treeContainer.querySelectorAll('.tree-item');

                items.forEach(item => {
                    item.classList.remove('highlight');
                });

                if (!query) return;

                items.forEach(item => {
                    const text = item.textContent.toLowerCase();
                    if (text.includes(query)) {
                        item.classList.add('highlight');
                        
                        // Expand parent nodes
                        let parent = item.closest('.tree-children');
                        while (parent) {
                            parent.classList.remove('collapsed');
                            const toggle = parent.previousElementSibling?.querySelector('.tree-toggle');
                            if (toggle) {
                                toggle.classList.remove('collapsed');
                                toggle.classList.add('expanded');
                            }
                            parent = parent.parentElement?.closest('.tree-children');
                        }
                    }
                });
            }

            // ============================================
            // Expand/Collapse
            // ============================================

            expandAll() {
                const toggles = this.treeContainer.querySelectorAll('.tree-toggle');
                const children = this.treeContainer.querySelectorAll('.tree-children');
                
                toggles.forEach(t => {
                    t.classList.remove('collapsed');
                    t.classList.add('expanded');
                });
                
                children.forEach(c => c.classList.remove('collapsed'));
            }

            collapseAll() {
                const toggles = this.treeContainer.querySelectorAll('.tree-toggle');
                const children = this.treeContainer.querySelectorAll('.tree-children');
                
                toggles.forEach(t => {
                    t.classList.remove('expanded');
                    t.classList.add('collapsed');
                });
                
                children.forEach(c => c.classList.add('collapsed'));
            }

            toggleWrap() {
                const isWrapped = this.editor.style.whiteSpace === 'pre-wrap';
                this.editor.style.whiteSpace = isWrapped ? 'pre' : 'pre-wrap';
                this.editor.style.wordBreak = isWrapped ? 'normal' : 'break-word';
            }

            // ============================================
            // History (Undo/Redo)
            // ============================================

            saveToHistory(text) {
                // Remove future history if we're not at the end
                if (this.historyIndex < this.history.length - 1) {
                    this.history = this.history.slice(0, this.historyIndex + 1);
                }

                // Don't save duplicates
                if (this.history[this.history.length - 1] === text) return;

                this.history.push(text);
                
                if (this.history.length > this.maxHistory) {
                    this.history.shift();
                }
                
                this.historyIndex = this.history.length - 1;
            }

            undo() {
                if (this.historyIndex > 0) {
                    this.historyIndex--;
                    this.isUpdating = true;
                    this.editor.value = this.history[this.historyIndex];
                    this.isUpdating = false;
                    this.handleEditorInput();
                }
            }

            redo() {
                if (this.historyIndex < this.history.length - 1) {
                    this.historyIndex++;
                    this.isUpdating = true;
                    this.editor.value = this.history[this.historyIndex];
                    this.isUpdating = false;
                    this.handleEditorInput();
                }
            }

            // ============================================
            // Context Menu
            // ============================================

            showContextMenu(e, path, data) {
                this.contextMenuTarget = { path, data };
                this.contextMenu.style.left = e.pageX + 'px';
                this.contextMenu.style.top = e.pageY + 'px';
                this.contextMenu.classList.add('show');
            }

            hideContextMenu() {
                this.contextMenu.classList.remove('show');
            }

            async handleContextMenuClick(e) {
                const action = e.target.dataset.action;
                if (!action || !this.contextMenuTarget) return;

                const { path, data } = this.contextMenuTarget;

                switch (action) {
                    case 'copy-value':
                        const valueToCopy = typeof data === 'object' ? JSON.stringify(data, null, 2) : String(data);
                        await navigator.clipboard.writeText(valueToCopy);
                        this.showToast('Value copied', 'success');
                        break;
                    case 'copy-path':
                        await navigator.clipboard.writeText(path);
                        this.showToast('Path copied', 'success');
                        break;
                    case 'delete':
                        this.deleteAtPath(path);
                        break;
                    case 'add-property':
                        this.showToast('Click on a value to edit, or modify the raw JSON', 'info');
                        break;
                }

                this.hideContextMenu();
            }

            deleteAtPath(path) {
                const parts = this.parsePath(path);
                if (parts.length === 0) {
                    this.clearAll();
                    return;
                }

                const parentParts = parts.slice(0, -1);
                const key = parts[parts.length - 1];
                const parent = parentParts.length ? this.getValueAtPath(parentParts) : this.jsonData;

                if (Array.isArray(parent)) {
                    parent.splice(key, 1);
                } else if (typeof parent === 'object') {
                    delete parent[key];
                }

                this.syncEditorFromTree();
                this.renderTree();
                this.showToast('Deleted', 'success');
            }

            // ============================================
            // Resizer
            // ============================================

            initResizer() {
                let isResizing = false;
                const leftPanel = document.querySelector('.panel-left');
                const rightPanel = document.querySelector('.panel-right');

                this.resizer.addEventListener('mousedown', (e) => {
                    isResizing = true;
                    this.resizer.classList.add('active');
                });

                document.addEventListener('mousemove', (e) => {
                    if (!isResizing) return;

                    const containerRect = document.querySelector('.main-container').getBoundingClientRect();
                    const percentage = ((e.clientX - containerRect.left) / containerRect.width) * 100;

                    if (percentage > 20 && percentage < 80) {
                        leftPanel.style.flex = `0 0 ${percentage}%`;
                        rightPanel.style.flex = `0 0 ${100 - percentage}%`;
                    }
                });

                document.addEventListener('mouseup', () => {
                    isResizing = false;
                    this.resizer.classList.remove('active');
                });
            }

            // ============================================
            // Keyboard Shortcuts
            // ============================================

            handleKeydown(e) {
                // Ctrl/Cmd + Shift + F - Format
                if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'F') {
                    e.preventDefault();
                    this.formatJSON();
                }
                
                // Ctrl/Cmd + F - Focus search
                if ((e.ctrlKey || e.metaKey) && e.key === 'f' && !e.shiftKey) {
                    if (document.activeElement !== this.editor) {
                        e.preventDefault();
                        this.searchInput.focus();
                    }
                }

                // Ctrl/Cmd + Z - Undo
                if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
                    if (document.activeElement === this.editor) {
                        // Let browser handle it
                    }
                }

                // Escape - Clear search
                if (e.key === 'Escape') {
                    this.searchInput.value = '';
                    this.handleSearch();
                    this.searchInput.blur();
                }
            }

            // ============================================
            // Toast Notifications
            // ============================================

            showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;

                this.toastContainer.appendChild(toast);

                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateX(20px)';
                    setTimeout(() => toast.remove(), 300);
                }, 2500);
            }
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            window.jsonTool = new JSONTool();
        });
    </script>
</body>
</html>

